{# for use in listen_addresses and site-catchall.conf #}
{% macro listen_addresses(port, default_server, use_x_forwarded) %}
listen {{ port }}      {% if default_server %}default_server{% endif %};
listen [::]:{{ port }} {% if default_server %}ipv6only=on default_server{% endif %};

{% if use_x_forwarded|default(False) %}
set_real_ip_from  {{ use_x_forwarded.from }};
real_ip_header    X-Forwarded-For;
{% endif %}
{% endmacro %}

{# This is both horrific and hilarious >_> #}
{# For use in a state file, to modify the nginx states #}
{% macro set_listen_addresses(port=80, use_x_forwarded=None) %}
extend:
    {% for state in ("/etc/nginx/listen_addresses", "/etc/nginx/conf.d/catchall.conf") %}
    {{ state }}:
        file.managed:
            - defaults:
                  port: {{ port }}
                  {% if use_x_forwarded is sameas True %}
                  use_x_forwarded: {from: 127.0.0.1}
                  {% elif use_x_forwarded %}
                  use_x_forwarded: {from: {{ use_x_forwarded.from }}}
                  {% endif %}
    {% endfor %}
{% endmacro %}

{# Short macro to grab SSL key and cert files from Pillar #}
{% macro depoy_ssl_files(hostname) %}
/etc/ssl/private/{{ hostname }}.crt:
  file.managed:
    - show_diff: false
    - mode: 600
    - contents_pillar: ssl:{{ hostname|replace('.', '_') }}:cert
    - watch_in:
      - service: nginx
/etc/ssl/private/{{ hostname }}.key:
  file.managed:
    - show_diff: false
    - mode: 600
    - contents_pillar: ssl:{{ hostname|replace('.', '_') }}:key
    - watch_in:
      - service: nginx
{% endmacro %}
